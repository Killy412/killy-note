# Seata

## 相关概念

### seata相关术语

- TC(transaction coordinator): 事物协调器,维护全局事物的运行状态. 对应的是seata服务
- TM(transaction manager): 控制全局事物的边界,负责开启一个全局事物
- RM(resource manager): 控制分支事物,负责分支注册,状态汇报,与TC交谈,接受TC的提交或回滚操作

## 事物模式

分布式事物就解决方案,提供了AT/TCC/SAGA/XA事物模式.

### AT 模式

使用场景是基于支持ACID事物的关系型数据库以及是通过jdbc访问数据库.

#### 整体机制

- 一阶段: 业务数据和回滚日志记录在同一个本地事物中提交,释放本地锁和连接资源.
  > 分支(本地)事物执行. 将本地事物作为分布式事物的一个分支.
  > 
  > 在此阶段,seata会拦截业务sql,解析sql语义,查询需要更新的sql,在更新前将查询的数据保存为`before image`,在业务数据更新后,再保存一份为`after image`,最后生成锁. 这些操作在一个数据库事物内完成,保证了原子性.
- 二阶段: 
  - 提交异步化,非常快速的完成.
  - 回滚通过一阶段的回滚日志进行反向补偿.
  > 分支事物提交或者回滚. 阶段二完成的是全局事物的提交或者回滚,当全局事务中所有分支事物都执行成功之后,TM会向TC发起全局事务提交的通知,TC收到之后,再通知RM进行提交. 如果某个分支失败了,TM会通知TC进行全局回滚,TC通知RM进行回滚.
  > 
  > 此阶段会会根据第一阶段的执行情况决定是提交还是回滚. 等到一阶段未抛异常,全局事务的发起方会向服务端申请提交这个事物,服务端根据xid查询出该全局事务后加锁并关闭这个全局事物.为了防止有分支事物继续注册到这个分布式事物上,将其状态从begin修改为committing. 接着服务端判断全局事物是否为AT模式,是的话则进行异步提交,因为AT模式下此阶段数据已经修改,服务端只需要修改事物状态为AsyncCommitting,然后会有一个定时线程池去db或file中查询待提交的全局事物日志进行提交,提交成功会释放全局锁并且删除事物日志.

#### 流程

1. TM通知TC开启一个分布式事物,TC生成一个XID.
2. XID经由调用链传递下去
3. RM将本地事物注册为XID对应的分支事物
4. TM通知TC进行全局回滚或提交
5. TC驱动XID对应的所有分支事物进行回滚或提交.

### TCC(try-confirm-cancel)模式

不依赖底层数据资源的支持.